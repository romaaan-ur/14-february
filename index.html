<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>14 February Valentine card</title>

  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <!-- we import arjs version without NFT but with marker + location based support -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    .arjs-loader {
      height: 100vh;
      width: 100vw;
      position: fixed;
      top: 0;
      left: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
      font-family: 'Poppins', sans-serif;
    }

    .arjs-loader.hidden {
      opacity: 0;
      visibility: hidden;
    }

    .loader-content {
      text-align: center;
      color: white;
    }

    .loader-spinner {
      width: 80px;
      height: 80px;
      margin: 0 auto 30px;
      position: relative;
    }

    .spinner-ring {
      position: absolute;
      width: 100%;
      height: 100%;
      border: 4px solid transparent;
      border-top-color: rgba(255, 255, 255, 0.9);
      border-radius: 50%;
      animation: spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
    }

    .spinner-ring:nth-child(1) {
      animation-delay: -0.45s;
    }

    .spinner-ring:nth-child(2) {
      animation-delay: -0.3s;
      border-top-color: rgba(255, 255, 255, 0.7);
      width: 70%;
      height: 70%;
      top: 15%;
      left: 15%;
    }

    .spinner-ring:nth-child(3) {
      animation-delay: -0.15s;
      border-top-color: rgba(255, 255, 255, 0.5);
      width: 50%;
      height: 50%;
      top: 25%;
      left: 25%;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .loader-title {
      font-size: 2em;
      font-weight: 600;
      margin-bottom: 10px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      letter-spacing: 1px;
    }

    .loader-subtitle {
      font-size: 1em;
      font-weight: 300;
      opacity: 0.9;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 0.9;
      }

      50% {
        opacity: 0.6;
      }
    }

    .heart-icon {
      font-size: 1.5em;
      margin: 0 5px;
      display: inline-block;
      animation: heartbeat 1.5s ease-in-out infinite;
    }

    @keyframes heartbeat {

      0%,
      100% {
        transform: scale(1);
      }

      25% {
        transform: scale(1.2);
      }

      50% {
        transform: scale(1);
      }
    }

    @media (max-width: 768px) {
      .loader-title {
        font-size: 1.5em;
        padding: 0 20px;
      }

      .loader-subtitle {
        font-size: 0.9em;
        padding: 0 20px;
      }

      .loader-spinner {
        width: 60px;
        height: 60px;
      }
    }

    /* Mobile-specific fixes */
    @media (max-width: 480px) {
      .loader-title {
        font-size: 1.2em;
      }

      .loader-subtitle {
        font-size: 0.85em;
      }
    }
  </style>
</head>

<body style="margin: 0px; overflow: hidden;">
  <div class="arjs-loader">
    <div class="loader-content">
      <div class="loader-spinner">
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
      </div>
      <div class="loader-title">Preparing Your Experience <span class="heart-icon">üíù</span></div>
      <div class="loader-subtitle">Please wait while we set everything up...</div>
    </div>
  </div>
  <a-scene arjs embedded id="scene">
    <a-assets>
      <a-asset-item id="trex"
        src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/examples/image-tracking/nft/trex/scene.gltf" /></a-asset-item>
    </a-assets>
    <a-marker preset="hiro">
      <a-entity position="0 0 0" scale="0.05 0.05 0.05" gltf-model="#trex">
      </a-entity>
    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // Check if device is mobile
    function isMobile() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
        (window.innerWidth <= 768);
    }

    // Check if HTTPS is required (AR.js needs HTTPS on mobile except localhost)
    function checkHTTPS() {
      if (isMobile() && location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
        const loader = document.querySelector('.arjs-loader');
        if (loader) {
          loader.innerHTML = `
            <div class="loader-content">
              <div class="loader-title">‚ö†Ô∏è HTTPS Required</div>
              <div class="loader-subtitle">AR.js requires HTTPS on mobile devices. Please use HTTPS or test on localhost.</div>
            </div>
          `;
        }
        return false;
      }
      return true;
    }

    // Request camera permissions
    async function requestCameraPermission() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        // Stop the stream immediately, we just needed permission
        stream.getTracks().forEach(track => track.stop());
        return true;
      } catch (error) {
        console.error('Camera permission denied:', error);
        const loader = document.querySelector('.arjs-loader');
        if (loader) {
          loader.innerHTML = `
            <div class="loader-content">
              <div class="loader-title">üì∑ Camera Access Required</div>
              <div class="loader-subtitle">Please allow camera access to use AR features.</div>
            </div>
          `;
        }
        return false;
      }
    }

    function hideLoader() {
      const loader = document.querySelector('.arjs-loader');
      if (loader) {
        loader.classList.add('hidden');
        setTimeout(function () {
          loader.style.display = 'none';
        }, 500);
      }
    }

    // Initialize AR
    async function initAR() {
      if (!checkHTTPS()) {
        return;
      }

      const scene = document.querySelector('a-scene');
      if (!scene) {
        console.error('Scene not found');
        return;
      }

      // Request camera permission on mobile
      if (isMobile()) {
        try {
          const hasPermission = await requestCameraPermission();
          if (!hasPermission) {
            return;
          }
        } catch (error) {
          console.warn('Camera permission check failed, continuing anyway:', error);
        }
      }

      // Wait for scene to be ready
      if (scene.hasLoaded) {
        setupAR();
      } else {
        scene.addEventListener('loaded', setupAR);
        // Timeout fallback
        setTimeout(setupAR, 3000);
      }
    }

    function setupAR() {
      const scene = document.querySelector('a-scene');

      // Hide loader when video is ready
      const videoLoadedHandler = function () {
        hideLoader();
      };

      window.addEventListener('arjs-video-loaded', videoLoadedHandler);

      // Fallback: hide loader after scene is loaded
      const sceneLoadedHandler = function () {
        setTimeout(function () {
          hideLoader();
        }, 2000);
      };

      if (scene.hasLoaded) {
        sceneLoadedHandler();
      } else {
        scene.addEventListener('loaded', sceneLoadedHandler);
      }

      // Error handling
      const errorHandler = function (e) {
        console.error('AR.js error:', e);
        const loader = document.querySelector('.arjs-loader');
        if (loader && !loader.classList.contains('hidden')) {
          loader.innerHTML = `
            <div class="loader-content">
              <div class="loader-title">‚ùå AR Error</div>
              <div class="loader-subtitle">Please refresh the page and ensure camera access is granted.</div>
            </div>
          `;
        }
      };

      scene.addEventListener('error', errorHandler);

      // Handle camera errors specifically
      window.addEventListener('arjs-nft-loaded', function () {
        hideLoader();
      });

      // Additional timeout fallback
      setTimeout(function () {
        const loader = document.querySelector('.arjs-loader');
        if (loader && !loader.classList.contains('hidden')) {
          hideLoader();
        }
      }, 5000);
    }

    // Start initialization when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initAR);
    } else {
      initAR();
    }
  </script>
</body>

</html>