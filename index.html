<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>14 February Valentine card</title>

  <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
  <script src="https://raw.githack.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.min.js"></script>
  <script src="./js/aframe-gif-shader.min.js"></script>

  <link rel="stylesheet" href="./public/main.css">
</head>

<body style="margin: 0px; overflow: hidden;">
  <div class="arjs-loader">
    <div class="loader-content">
      <div class="loader-spinner">
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
      </div>
      <div class="loader-title">Preparing Your Experience <span class="heart-icon">üíù</span></div>
      <div class="loader-subtitle">Please wait while we set everything up...</div>
    </div>
  </div>
  <a-scene embedded vr-mode-ui="enabled: false;"
    arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;'>
    <a-assets>
      <img id="swan" src="./public/assets/swan.gif">
      <img id="lovebirds" src="./public/assets/lovebirds.gif">
      <img id="seahorses" src="./public/assets/seahorses.gif">
    </a-assets>

    <a-marker type='barcode' value='1'>
      <a-entity geometry="primitive:box;width:2;height:2" material="shader: gif; src: #swan;"></a-entity>
    </a-marker>

    <a-marker type='barcode' value='2'>
      <a-entity geometry="primitive:box;width:2;height:2" material="shader: gif; src: #lovebirds;"></a-entity>
    </a-marker>

    <a-marker type='barcode' value='3'>
      <a-entity geometry="primitive:box;width:2;height:2" material="shader: gif; src: #seahorses;"></a-entity>
    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>
  <script>
    // Check if device is mobile
    function isMobile() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
        (window.innerWidth <= 768);
    }

    // Request camera permissions
    async function requestCameraPermission() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        // Stop the stream immediately, we just needed permission
        stream.getTracks().forEach(track => track.stop());
        return true;
      } catch (error) {
        console.error('Camera permission denied:', error);
        const loader = document.querySelector('.arjs-loader');
        if (loader) {
          loader.innerHTML = `
            <div class="loader-content">
              <div class="loader-title">üì∑ Camera Access Required</div>
              <div class="loader-subtitle">Please allow camera access to use AR features.</div>
            </div>
          `;
        }
        return false;
      }
    }

    function hideLoader() {
      const loader = document.querySelector('.arjs-loader');
      if (loader) {
        loader.classList.add('hidden');
        setTimeout(function () {
          loader.style.display = 'none';
        }, 500);
      }
    }

    // Initialize AR
    async function initAR() {
      const scene = document.querySelector('a-scene');

      if (!scene) {
        console.error('Scene not found');
        return;
      }

      // Request camera permission on mobile
      if (isMobile()) {
        try {
          const hasPermission = await requestCameraPermission();
          if (!hasPermission) {
            return;
          }
        } catch (error) {
          console.warn('Camera permission check failed, continuing anyway:', error);
        }
      }

      // Wait for scene to be ready
      if (scene.hasLoaded) {
        setupAR();
      } else {
        scene.addEventListener('loaded', setupAR);
        // Timeout fallback
        setTimeout(setupAR, 3000);
      }
    }

    function setupAR() {
      const scene = document.querySelector('a-scene');

      // Hide loader when video is ready
      const videoLoadedHandler = function () {
        hideLoader();
      };

      window.addEventListener('arjs-video-loaded', videoLoadedHandler);

      // Fallback: hide loader after scene is loaded
      const sceneLoadedHandler = function () {
        setTimeout(function () {
          hideLoader();
        }, 2000);
      };

      if (scene.hasLoaded) {
        sceneLoadedHandler();
      } else {
        scene.addEventListener('loaded', sceneLoadedHandler);
      }

      // Error handling
      const errorHandler = function (e) {
        console.error('AR.js error:', e);
        const loader = document.querySelector('.arjs-loader');
        if (loader && !loader.classList.contains('hidden')) {
          loader.innerHTML = `
            <div class="loader-content">
              <div class="loader-title">‚ùå AR Error</div>
              <div class="loader-subtitle">Please refresh the page and ensure camera access is granted.</div>
            </div>
          `;
        }
      };

      scene.addEventListener('error', errorHandler);

      // Handle camera errors specifically
      window.addEventListener('arjs-nft-loaded', function () {
        hideLoader();
      });

      // Additional timeout fallback
      setTimeout(function () {
        const loader = document.querySelector('.arjs-loader');
        if (loader && !loader.classList.contains('hidden')) {
          hideLoader();
        }
      }, 5000);
    }

    // Start initialization when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initAR);
    } else {
      initAR();
    }
  </script>
</body>

</html>